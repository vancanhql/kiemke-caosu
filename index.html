<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Ki·ªÉm k√™ v∆∞·ªùn c√¢y cao su</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2e7d32">

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --green-main:#2e7d32;
  --green-light:#e8f5e9;
  --green-btn:#43a047;
  --orange:#fb8c00;
  --yellow:#fdd835;
  --purple:#7e57c2;
  --red:#e53935;
  --gray:#6c757d;
}

body{
  font-family:"Segoe UI",Arial,sans-serif;
  margin:0;
  background:linear-gradient(#e8f5e9,#ffffff);
}

header{
  background:var(--green-main);
  color:white;
  padding:14px;
  text-align:center;
  font-size:22px;
  font-weight:bold;
}

.container{ padding:12px; }

.box{
  background:white;
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
}

h3{
  text-align:center;
  margin-top:0;
  color:var(--green-main);
}

input{
  width:100%;
  font-size:18px;
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
  margin-bottom:10px;
}

button{
  border:none;
  border-radius:14px;
  font-size:22px;
  height:70px;
  margin:6px 4px;
  cursor:pointer;
}

.btn-tree{
  height:100px;
  font-size:34px;
  font-weight:bold;
  border-radius:22px;
}

.btn-full{
  width:100%;
  background:var(--green-btn);
  color:white;
  height:56px;
  font-size:18px;
}

.btn-small{
  width:100%;
  height:50px;
  font-size:16px;
  background:#eeeeee;
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
}

.btn-G{background:#66bb6a;color:white;}
.btn-O{background:var(--orange);color:white;}
.btn-K1{background:var(--yellow);}
.btn-K2{background:var(--purple);color:white;}
.btn-D{grid-column:1/3;background:var(--red);color:white;}

#tree{
  text-align:center;
  font-size:28px;
  margin:8px 0;
}

#info{
  text-align:center;
  font-size:16px;
  color:#555;
}

#lastType{
  text-align:center;
  font-weight:bold;
  font-size:20px;
  margin-bottom:6px;
}

footer{
  text-align:center;
  font-size:13px;
  color:#555;
  padding:10px 0 14px;
}

/* DANH S√ÅCH L√î */
.lo-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  margin-bottom:8px;
  border-radius:10px;
  background:#f5f5f5;
}

.lo-info{ font-size:14px; }

.btn-del-lo{
  background:#e53935;
  color:white;
  border:none;
  border-radius:50%;
  width:38px;
  height:38px;
  font-size:20px;
  cursor:pointer;
}
</style>
</head>

<body>

<header>üå± KI·ªÇM K√ä V∆Ø·ªúN C√ÇY CAO SU</header>

<div class="container">

<!-- KH·ªûI T·∫†O -->
<div id="setup" class="box">
  <h3>Kh·ªüi t·∫°o l√¥</h3>
  T√™n l√¥ <input id="lo">
  NƒÉm tr·ªìng <input id="namTrong" type="number">
  Di·ªán t√≠ch (ha) <input id="dienTich" type="number" step="0.01">
  H√†ng b·∫Øt ƒë·∫ßu <input id="hangBatDau" type="number" value="1">
  <button class="btn-full" onclick="startLo()">B·∫ÆT ƒê·∫¶U KI·ªÇM K√ä</button>
</div>

<!-- KI·ªÇM K√ä -->
<div id="counter" class="box" style="display:none;">
  <div id="info"></div>
  <div id="tree">C√¢y s·ªë: 1</div>
  <div id="lastType">V·ª´a nh·∫≠p: -</div>

  <div class="grid">
    <button class="btn-G btn-tree" onclick="count('G')">G</button>
    <button class="btn-O btn-tree" onclick="count('O')">O</button>
    <button class="btn-K1 btn-tree" onclick="count('K1')">K1</button>
    <button class="btn-K2 btn-tree" onclick="count('K2')">K2</button>
    <button class="btn-D btn-tree" onclick="count('D')">D</button>
  </div>

  <button class="btn-small" onclick="undoLast()">‚Ü© S·ª¨A C√ÇY V·ª™A NH·∫¨P</button>
  <button class="btn-full" onclick="finishRow()">HO√ÄN T·∫§T H√ÄNG</button>
  <button class="btn-small" onclick="endLo()">‚èπ K·∫æT TH√öC L√î</button>

</div>

<!-- CH·ª®C NƒÇNG -->
<div class="box">
  <button class="btn-full" onclick="exportAll()">XU·∫§T EXCEL KI·ªÇM K√ä</button>
  <button class="btn-small" onclick="showDsLo()">üìÇ DANH S√ÅCH L√î ƒê√É L∆ØU</button>
  <button class="btn-small" onclick="clearData()">XO√Å TO√ÄN B·ªò D·ªÆ LI·ªÜU</button>
</div>

<!-- TRANG DANH S√ÅCH L√î -->
<div id="pageDsLo" class="box" style="display:none;">
  <h3>Danh s√°ch l√¥ ƒë√£ l∆∞u</h3>
  <div id="dsLoView"></div>
  <button class="btn-small" onclick="showMain()">‚¨Ö Quay l·∫°i</button>
</div>

</div>

<footer>¬© Copyright <b>vancanhql@gmail.com</b></footer>

<!-- TOAST -->
<div id="toast" style="
position:fixed;
bottom:30px;
left:50%;
transform:translateX(-50%);
background:#2e7d32;
color:white;
padding:12px 20px;
border-radius:20px;
font-size:18px;
display:none;
z-index:9999;"></div>

<script>
/* ===== TI·ªÜN √çCH ===== */
function vibrate(p){ if(navigator.vibrate) navigator.vibrate(p); }
function showToast(m){
  let t=document.getElementById("toast");
  t.innerText=m; t.style.display="block";
  setTimeout(()=>t.style.display="none",2000);
}

const typeColors={G:"#66bb6a",O:"#fb8c00",K1:"#fdd835",K2:"#7e57c2",D:"#e53935"};

let dsLo=JSON.parse(localStorage.getItem("dsLo")||"[]");
let loHT=null,hang=1,cay=1;

/* ===== KI·ªÇM K√ä ===== */
function startLo(){
  loHT={
    lo:lo.value,
    namTrong:namTrong.value,
    dienTich:dienTich.value,
    hangBatDau:+hangBatDau.value,
    data:[]
  };

  hang = loHT.hangBatDau;  // ‚≠ê m·ªëc h√†ng do ng∆∞·ªùi d√πng nh·∫≠p
  cay = 1;

  setup.style.display="none";
  counter.style.display="block";

  resetLastType();
  updateInfo();
}


function updateInfo(){
  info.innerText=
    `L√¥: ${loHT.lo} | NƒÉm tr·ªìng: ${loHT.namTrong} | DT: ${loHT.dienTich} ha | H√†ng ƒëang ki·ªÉm: ${hang}`;
  tree.innerText=`C√¢y s·ªë: ${cay}`;
}

function resetLastType(){ lastType.innerText="V·ª´a nh·∫≠p: -"; lastType.style.color="#000"; }

function count(type){
  vibrate(type==="D"?[200,100,200]:50);
  loHT.data.push({hang,cay,type});
  lastType.innerText="V·ª´a nh·∫≠p: "+type;
  lastType.style.color=typeColors[type];
  cay++; updateInfo();
}

function undoLast(){
  if(!loHT.data.length) return;
  let l=loHT.data.at(-1);
  if(l.hang!==hang) return;
  loHT.data.pop(); cay=Math.max(1,cay-1);
  lastType.innerText="V·ª´a nh·∫≠p: (ƒë√£ xo√°)";
  lastType.style.color="#6c757d";
  updateInfo();
}

function thongKeHang(h){
  let d={G:0,O:0,K1:0,K2:0,D:0};
  loHT.data.filter(x=>x.hang===h).forEach(x=>d[x.type]++);
  return d;
}

function finishRow(){
  let d=thongKeHang(hang);
  vibrate(300);
  showToast(`H√†ng ${hang}: G=${d.G} | O=${d.O} | K1=${d.K1} | K2=${d.K2} | D=${d.D}`);

  hang++;   // ‚≠ê t·ª± c·ªông d·ªìn
  cay=1;

  resetLastType();
  updateInfo();
}


function finishLo(){
  dsLo.push(loHT);
  localStorage.setItem("dsLo",JSON.stringify(dsLo));
  showToast(`ƒê√£ l∆∞u xong l√¥ ${loHT.lo}`);
  counter.style.display="none";
  setup.style.display="block";
}

/* ===== DANH S√ÅCH L√î ===== */
function countSoHang(lo){
  if(!lo.data || lo.data.length === 0) return 0;
  return new Set(lo.data.map(d => d.hang)).size;
}

/* ===== DANH S√ÅCH L√î ===== */
function renderDsLo(){
  let wrap = document.getElementById("dsLoView");
  let ds = JSON.parse(localStorage.getItem("dsLo") || "[]");

  wrap.innerHTML = ds.length ? "" : "<i>Ch∆∞a c√≥ l√¥ n√†o</i>";

  ds.forEach((lo, i) => {
    let dem = {G:0,O:0,K1:0,K2:0,D:0};
    lo.data.forEach(d => dem[d.type]++);

    wrap.innerHTML += `
    <div class="lo-item">
      <div class="lo-info">
        <b>${lo.lo}</b> ‚Äì ${lo.namTrong}<br>
        DT:${lo.dienTich}ha |
        H:${countSoHang(lo)} |
        C√¢y:${lo.data.length}<br>
        G:${dem.G} O:${dem.O} K1:${dem.K1} K2:${dem.K2} D:${dem.D}
      </div>
      <button class="btn-del-lo" onclick="deleteLo(${i})">‚ùå</button>
    </div>`;
  });
}


function deleteLo(i){
  let ds=JSON.parse(localStorage.getItem("dsLo")||"[]");
  if(!confirm(`Xo√° l√¥ "${ds[i].lo}"?`)) return;
  ds.splice(i,1);
  localStorage.setItem("dsLo",JSON.stringify(ds));
  showToast("ƒê√£ xo√° l√¥");
  renderDsLo();
}

/* ===== ƒêI·ªÄU H∆Ø·ªöNG ===== */
function showDsLo(){
  setup.style.display="none";
  counter.style.display="none";
  pageDsLo.style.display="block";
  renderDsLo();
}

function showMain(){
  pageDsLo.style.display="none";
  loHT?counter.style.display="block":setup.style.display="block";
}

/* ===== XO√Å ALL ===== */
function clearData(){
  if(!confirm("Xo√° to√†n b·ªô d·ªØ li·ªáu?")) return;
  localStorage.removeItem("dsLo");
  dsLo=[]; loHT=null; hang=1; cay=1;
  pageDsLo.style.display="none";
  counter.style.display="none";
  setup.style.display="block";
  showToast("ƒê√£ xo√° to√†n b·ªô d·ªØ li·ªáu");
}
/* ===== XU·∫§T EXCEL ===== */
function exportAll(){
  let ds = JSON.parse(localStorage.getItem("dsLo") || "[]");
  if(ds.length === 0){
    showToast("Ch∆∞a c√≥ l√¥ n√†o ƒë·ªÉ xu·∫•t");
    return;
  }

  let wb = XLSX.utils.book_new();

  /* ===== SHEET 1: T·ªîNG H·ª¢P L√î ===== */
  let tongHopLo = [[
    "STT","T√™n l√¥","NƒÉm tr·ªìng","Di·ªán t√≠ch (ha)","S·ªë h√†ng",
    "T·ªïng c√¢y","G","O","K1","K2","D"
  ]];

  ds.forEach((lo, i) => {
    let dem = {G:0,O:0,K1:0,K2:0,D:0};
    lo.data.forEach(d => dem[d.type]++);

    tongHopLo.push([
      i+1, lo.lo, lo.namTrong, lo.dienTich,
      countSoHang(lo), lo.data.length,
      dem.G, dem.O, dem.K1, dem.K2, dem.D
    ]);
  });

  XLSX.utils.book_append_sheet(
    wb,
    XLSX.utils.aoa_to_sheet(tongHopLo),
    "TONG_HOP_LO"
  );

  /* ===== SHEET THEO H√ÄNG ===== */
/* ===== SHEET THEO H√ÄNG ===== */
ds.forEach((lo, i) => {
  let theoHang = [["H√†ng","T·ªïng c√¢y","G","O","K1","K2","D"]];

  const hangList = [...new Set(lo.data.map(d => d.hang))].sort((a,b)=>a-b);

  hangList.forEach(h => {
    let dem = {G:0,O:0,K1:0,K2:0,D:0};
    lo.data.filter(d => d.hang === h).forEach(d => dem[d.type]++);

    theoHang.push([
      h,
      dem.G + dem.O + dem.K1 + dem.K2 + dem.D,
      dem.G, dem.O, dem.K1, dem.K2, dem.D
    ]);
  });

  XLSX.utils.book_append_sheet(
    wb,
    XLSX.utils.aoa_to_sheet(theoHang),
    `LO_${i+1}_HANG`
  );
});


  /* ===== SHEET CHI TI·∫æT ===== */
  ds.forEach((lo, i) => {
    let ct=[["STT","T√™n l√¥","NƒÉm tr·ªìng","Di·ªán t√≠ch","H√†ng","C√¢y","Lo·∫°i"]];

    lo.data.forEach((d,j)=>{
      ct.push([
        j+1, lo.lo, lo.namTrong, lo.dienTich,
        d.hang, d.cay, d.type
      ]);
    });

    XLSX.utils.book_append_sheet(
      wb,
      XLSX.utils.aoa_to_sheet(ct),
      `LO_${i+1}_CHI_TIET`
    );
  });

  XLSX.writeFile(wb,"KiemKe_CuoiNgay.xlsx");
}
function endLo(){
  vibrate([200,100,200]);

  if(!confirm(`K·∫øt th√∫c l√¥ "${loHT?.lo}" v√† l∆∞u d·ªØ li·ªáu?`)){
    return;
  }

  // Ch·ªâ l∆∞u khi c√≥ d·ªØ li·ªáu ki·ªÉm k√™
  if(loHT && loHT.data.length > 0){
    dsLo.push(loHT);
    localStorage.setItem("dsLo", JSON.stringify(dsLo));
    showToast(`‚úÖ ƒê√£ k·∫øt th√∫c l√¥ ${loHT.lo}`);
  }else{
    showToast("‚ÑπÔ∏è L√¥ ch∆∞a c√≥ d·ªØ li·ªáu");
  }

  // Reset tr·∫°ng th√°i
  loHT = null;
  hang = 1;
  cay = 1;

  // Quay v·ªÅ m√†n h√¨nh kh·ªüi t·∫°o
  counter.style.display = "none";
  setup.style.display = "block";
}
function countSoHang(lo){
  if(!lo.data || lo.data.length === 0) return 0;
  return new Set(lo.data.map(d => d.hang)).size;
}

  
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js").then(reg => {

    // Khi ph√°t hi·ªán service worker m·ªõi
    reg.onupdatefound = () => {
      const newWorker = reg.installing;

      newWorker.onstatechange = () => {
        if (
          newWorker.state === "installed" &&
          navigator.serviceWorker.controller
        ) {
          showUpdateToast();
        }
      };
    };

  });
}

function showUpdateToast(){
  const t = document.getElementById("toast");
  t.innerHTML = "üîÑ C√≥ phi√™n b·∫£n m·ªõi ‚Äì b·∫•m ƒë·ªÉ c·∫≠p nh·∫≠t";
  t.style.display = "block";

  t.onclick = () => {
    location.reload(true); // reload ƒë·ªÉ d√πng b·∫£n m·ªõi
  };
}
</script>


</body>
</html>





