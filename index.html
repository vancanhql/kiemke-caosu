<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Ki·ªÉm k√™ v∆∞·ªùn c√¢y cao su</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2e7d32">

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --green-main:#2e7d32;
  --green-light:#e8f5e9;
  --green-btn:#43a047;
  --orange:#fb8c00;
  --yellow:#fdd835;
  --purple:#7e57c2;
  --red:#e53935;
  --gray:#6c757d;
}

body{
  font-family: "Segoe UI", Arial, sans-serif;
  margin:0;
  background:linear-gradient(#e8f5e9,#ffffff);
}

header{
  background:var(--green-main);
  color:white;
  padding:14px;
  text-align:center;
  font-size:22px;
  font-weight:bold;
}

.container{ padding:12px; }

.box{
  background:white;
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
}

h3{
  text-align:center;
  margin-top:0;
  color:var(--green-main);
}

input{
  width:100%;
  font-size:18px;
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
  margin-bottom:10px;
}

button{
  border:none;
  border-radius:14px;
  font-size:22px;
  height:70px;
  margin:6px 4px;
  cursor:pointer;
}

.btn-full{
  width:100%;
  background:var(--green-btn);
  color:white;
}

.btn-small{
  width:100%;
  height:56px;
  font-size:18px;
  background:#eeeeee;
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
}

.btn-G{background:#66bb6a;color:white;}
.btn-O{background:var(--orange);color:white;}
.btn-K1{background:var(--yellow);}
.btn-K2{background:var(--purple);color:white;}
.btn-D{grid-column:1/3;background:var(--red);color:white;}

#tree{
  text-align:center;
  font-size:28px;
  margin:8px 0;
}

#info{
  text-align:center;
  font-size:16px;
  color:#555;
}

#lastType{
  text-align:center;
  font-weight:bold;
  font-size:20px;
  margin-bottom:6px;
}

footer{
  text-align:center;
  font-size:13px;
  color:#555;
  padding:10px 0 14px;
}
</style>
</head>

<body>

<header>üå± KI·ªÇM K√ä V∆Ø·ªúN C√ÇY CAO SU</header>

<div class="container">

<!-- KH·ªûI T·∫†O L√î -->
<div id="setup" class="box">
  <h3>Kh·ªüi t·∫°o l√¥</h3>
  T√™n l√¥ <input id="lo">
  NƒÉm tr·ªìng <input id="namTrong" type="number">
  Di·ªán t√≠ch (ha) <input id="dienTich" type="number" step="0.01">
  S·ªë h√†ng <input id="soHang" type="number">
  <button class="btn-full" onclick="startLo()">B·∫ÆT ƒê·∫¶U KI·ªÇM K√ä</button>
</div>

<!-- KI·ªÇM K√ä -->
<div id="counter" class="box" style="display:none;">
  <div id="info"></div>
  <div id="tree">C√¢y s·ªë: 1</div>
  <div id="lastType">V·ª´a nh·∫≠p: -</div>

  <div class="grid">
    <button class="btn-G" onclick="count('G')">G</button>
    <button class="btn-O" onclick="count('O')">O</button>
    <button class="btn-K1" onclick="count('K1')">K1</button>
    <button class="btn-K2" onclick="count('K2')">K2</button>
    <button class="btn-D" onclick="count('D')">D</button>
  </div>

  <button class="btn-small" onclick="undoLast()">‚Ü© S·ª¨A C√ÇY V·ª™A NH·∫¨P</button>
  <button class="btn-full" onclick="finishRow()">HO√ÄN T·∫§T H√ÄNG</button>
</div>

<!-- CU·ªêI NG√ÄY -->
<div class="box">
  <button class="btn-full" onclick="exportAll()">XU·∫§T EXCEL CU·ªêI NG√ÄY</button>
  <button class="btn-small" onclick="clearData()">XO√Å TO√ÄN B·ªò D·ªÆ LI·ªÜU</button>
</div>

</div>

<footer>¬© Copyright by <b>vancanhql@gmail.com</b></footer>

<script>
const typeColors={G:"#66bb6a",O:"#fb8c00",K1:"#fdd835",K2:"#7e57c2",D:"#e53935"};

let dsLo=JSON.parse(localStorage.getItem("dsLo")||"[]");
let loHT=null,hang=1,cay=1;

function startLo(){
  loHT={lo:lo.value,namTrong:namTrong.value,dienTich:dienTich.value,soHang:+soHang.value,data:[]};
  hang=1;cay=1;
  setup.style.display="none";
  counter.style.display="block";
  resetLastType();
  updateInfo();
}

function updateInfo(){
  info.innerText=`L√¥: ${loHT.lo} | NƒÉm tr·ªìng: ${loHT.namTrong} | DT: ${loHT.dienTich} ha | H√†ng: ${hang}/${loHT.soHang}`;
  tree.innerText=`C√¢y s·ªë: ${cay}`;
}

function resetLastType(){
  lastType.innerText="V·ª´a nh·∫≠p: -";
  lastType.style.color="#000";
}

function count(type){
  loHT.data.push({hang,cay,type});
  lastType.innerText="V·ª´a nh·∫≠p: "+type;
  lastType.style.color=typeColors[type];
  cay++; updateInfo();
}

function undoLast(){
  if(loHT.data.length===0) return alert("Ch∆∞a c√≥ c√¢y ƒë·ªÉ s·ª≠a");
  let last=loHT.data.at(-1);
  if(last.hang!==hang) return alert("Kh√¥ng th·ªÉ s·ª≠a c√¢y h√†ng tr∆∞·ªõc");
  loHT.data.pop(); cay=Math.max(1,cay-1);
  lastType.innerText="V·ª´a nh·∫≠p: (ƒë√£ xo√°)";
  lastType.style.color="#6c757d";
  updateInfo();
}

function finishRow(){
  showToast(`ƒê√£ xong h√†ng ${hang}`);
  hang++; cay=1;
  if(hang>loHT.soHang) finishLo();
  else{ resetLastType(); updateInfo(); }
}

function finishLo(){
  dsLo.push(loHT);
  localStorage.setItem("dsLo",JSON.stringify(dsLo));
  showToast(`ƒê√£ l∆∞u xong l√¥ ${loHT.lo}`);
  counter.style.display="none";
  setup.style.display="block";
}

function exportAll(){
  let ds=JSON.parse(localStorage.getItem("dsLo")||"[]");
  if(ds.length===0) return alert("Ch∆∞a c√≥ l√¥ n√†o");

  let wb=XLSX.utils.book_new();

  /* T·ªîNG H·ª¢P L√î */
  let thLo=[["STT","T√™n l√¥","NƒÉm tr·ªìng","Di·ªán t√≠ch","S·ªë h√†ng","T·ªïng c√¢y","G","O","K1","K2","D"]];
  ds.forEach((lo,i)=>{
    let d={G:0,O:0,K1:0,K2:0,D:0};
    lo.data.forEach(x=>d[x.type]++);
    thLo.push([i+1,lo.lo,lo.namTrong,lo.dienTich,lo.soHang,lo.data.length,d.G,d.O,d.K1,d.K2,d.D]);
  });
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(thLo),"TONG_HOP_LO");

  /* THEO H√ÄNG */
  ds.forEach((lo,i)=>{
    let sh=[["H√†ng","T·ªïng c√¢y","G","O","K1","K2","D"]];
    for(let h=1;h<=lo.soHang;h++){
      let d={G:0,O:0,K1:0,K2:0,D:0};
      lo.data.filter(x=>x.hang===h).forEach(x=>d[x.type]++);
      sh.push([h,d.G+d.O+d.K1+d.K2+d.D,d.G,d.O,d.K1,d.K2,d.D]);
    }
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(sh),`LO_${i+1}_TH`);
  });

  /* CHI TI·∫æT */
  ds.forEach((lo,i)=>{
    let ct=[["STT","T√™n l√¥","NƒÉm tr·ªìng","Di·ªán t√≠ch","H√†ng","C√¢y","Lo·∫°i"]];
    lo.data.forEach((x,j)=>ct.push([j+1,lo.lo,lo.namTrong,lo.dienTich,x.hang,x.cay,x.type]));
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(ct),`LO_${i+1}_CHI_TIET`);
  });

  XLSX.writeFile(wb,"KiemKe_CuoiNgay.xlsx");
}

function clearData(){
  if(confirm("Xo√° to√†n b·ªô d·ªØ li·ªáu?")){
    localStorage.removeItem("dsLo");
    dsLo=[];
   showToast("ƒê√£ xo√° to√†n b·ªô d·ªØ li·ªáu");
  }
}
  function showToast(msg){
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.style.display = "block";
  setTimeout(() => {
    t.style.display = "none";
  }, 2000);
}

</script>

<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js')
    .then(()=>console.log("PWA ready"))
    .catch(e=>console.error(e));
}
</script>
<div id="toast" style="
  position:fixed;
  bottom:30px;
  left:50%;
  transform:translateX(-50%);
  background:#2e7d32;
  color:white;
  padding:12px 20px;
  border-radius:20px;
  font-size:18px;
  display:none;
  z-index:9999;
">
</div>

</body>
</html>

